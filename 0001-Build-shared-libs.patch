From 31806d81f142a50647f8d15e75a2ebdd1b99e779 Mon Sep 17 00:00:00 2001
From: Robert Farmer <rjfarmer@asu.edu>
Date: Tue, 25 Jul 2017 16:18:52 +0100
Subject: [PATCH] Build shared libs

---
 adipls/export                    |  4 ++--
 adipls/make/makefile             |  2 +-
 atm/export                       |  2 +-
 atm/make/makefile                |  2 +-
 binary/export                    |  2 +-
 binary/make/makefile             |  2 +-
 chem/export                      |  2 +-
 chem/make/makefile               |  2 +-
 colors/export                    |  2 +-
 colors/make/makefile             |  2 +-
 const/export                     |  2 +-
 const/make/makefile              |  2 +-
 crlibm/build_and_test_mic_native |  2 +-
 crlibm/export                    |  2 +-
 crlibm/make/makefile             |  4 ++--
 eos/export                       |  2 +-
 eos/make/makefile                |  2 +-
 gyre/export                      |  2 +-
 gyre/make/makefile               |  2 +-
 interp_1d/export                 |  2 +-
 interp_1d/make/makefile          |  2 +-
 interp_2d/export                 |  2 +-
 interp_2d/make/makefile          |  2 +-
 ionization/export                |  2 +-
 ionization/make/makefile         |  2 +-
 kap/export                       |  2 +-
 kap/make/makefile                |  2 +-
 kap/private/kap_eval_support.f90 |  1 +
 mlt/export                       |  2 +-
 mlt/make/makefile                |  2 +-
 mtx/export                       | 10 +++++-----
 mtx/make/makefile                | 23 ++++++++++++++---------
 net/export                       |  2 +-
 net/make/makefile                |  2 +-
 neu/export                       |  2 +-
 neu/make/makefile                |  2 +-
 num/export                       |  2 +-
 num/make/makefile                |  2 +-
 package_template/export          |  2 +-
 package_template/make/makefile   |  2 +-
 rates/export                     |  2 +-
 rates/make/makefile              |  2 +-
 rates/private/weaklib_tables.f90 |  2 +-
 star/export                      |  2 +-
 star/make/makefile               |  2 +-
 utils/export                     |  2 +-
 utils/make/makefile              |  2 +-
 utils/makefile_header            | 12 +++++++-----
 48 files changed, 73 insertions(+), 65 deletions(-)

diff --git a/adipls/export b/adipls/export
index 1cd2fc0..41eb34d 100755
--- a/adipls/export
+++ b/adipls/export
@@ -1,3 +1,3 @@
-cp make/libadipls.a ../lib
+cp make/libadipls.so ../lib
 cd ../lib
-ranlib libadipls.a
+ranlib libadipls.so
diff --git a/adipls/make/makefile b/adipls/make/makefile
index 25fb031..406d74e 100644
--- a/adipls/make/makefile
+++ b/adipls/make/makefile
@@ -3,7 +3,7 @@ MESA_DIR = ../..
 
 include $(MESA_DIR)/utils/makefile_header
   
-LIB = libadipls.a
+LIB = libadipls.so
 ADIPLS_DIR = ../adipack.c/adipls
 ADIAJOBS_DIR = ../adipack.c/adiajobs
 GENSR_DIR = ../adipack.c/gensr
diff --git a/atm/export b/atm/export
index 4273b50..8ad2891 100755
--- a/atm/export
+++ b/atm/export
@@ -1,4 +1,4 @@
 cp make/atm_def.mod ../include
 cp make/atm_lib.mod ../include
 
-cp make/libatm*.a ../lib
+cp make/libatm*.so ../lib
diff --git a/atm/make/makefile b/atm/make/makefile
index d90ddac..6a6a5e8 100644
--- a/atm/make/makefile
+++ b/atm/make/makefile
@@ -23,7 +23,7 @@ SRCS = \
 #
 # TARGETS
 
-LIB = libatm.a
+LIB = libatm.so
 LIB_OBJS = $(patsubst %.f,%.o,$(patsubst %.f90,%.o,$(SRCS)))
 $(LIB) : $(LIB_OBJS)
 	$(LIB_TOOL) $(LIB) $(LIB_OBJS)
diff --git a/binary/export b/binary/export
index 5570fdb..23c80c2 100755
--- a/binary/export
+++ b/binary/export
@@ -1,4 +1,4 @@
 cp make/binary_lib.mod ../include
 cp make/binary_def.mod ../include
 
-cp make/libbinary*.a ../lib
+cp make/libbinary*.so ../lib
diff --git a/binary/make/makefile b/binary/make/makefile
index 4a3fe2e..aa34ea2 100644
--- a/binary/make/makefile
+++ b/binary/make/makefile
@@ -45,7 +45,7 @@ SRCS = \
 #
 # TARGETS
 
-LIB = libbinary.a
+LIB = libbinary.so
 LIB_OBJS = $(patsubst %.f,%.o,$(patsubst %.f90,%.o,$(SRCS)))
 $(LIB) : $(LIB_OBJS)
 	$(LIB_TOOL) $(LIB) $(LIB_OBJS)
diff --git a/chem/export b/chem/export
index 29d1dea..6d0cac9 100755
--- a/chem/export
+++ b/chem/export
@@ -1,4 +1,4 @@
 cp make/chem_lib.mod ../include
 cp make/chem_def.mod ../include
 
-cp make/libchem*.a ../lib
+cp make/libchem*.so ../lib
diff --git a/chem/make/makefile b/chem/make/makefile
index 2d66a26..e06672a 100644
--- a/chem/make/makefile
+++ b/chem/make/makefile
@@ -23,7 +23,7 @@ SRCS = \
 #
 # TARGETS
 
-LIB = libchem.a
+LIB = libchem.so
 LIB_OBJS = $(patsubst %.f,%.o,$(patsubst %.f90,%.o,$(SRCS)))
 $(LIB) : $(LIB_OBJS)
 	$(LIB_TOOL) $(LIB) $(LIB_OBJS)
diff --git a/colors/export b/colors/export
index 163ccff..db92550 100755
--- a/colors/export
+++ b/colors/export
@@ -1,4 +1,4 @@
 cp make/colors_lib.mod ../include
 cp make/colors_def.mod ../include
 
-cp make/libcolors*.a ../lib
+cp make/libcolors*.so ../lib
diff --git a/colors/make/makefile b/colors/make/makefile
index 6881be2..4c6ef04 100644
--- a/colors/make/makefile
+++ b/colors/make/makefile
@@ -21,7 +21,7 @@ SRCS = \
 #
 # TARGETS
 
-LIB = libcolors.a
+LIB = libcolors.so
 LIB_DEFS = colors_def.o
 LIB_OBJS = $(filter-out $(LIB_DEFS),$(patsubst %.f,%.o,$(patsubst %.f90,%.o,$(SRCS))))
 $(LIB) : $(LIB_DEFS) $(LIB_OBJS)
diff --git a/const/export b/const/export
index 9ebf280..d3a0870 100755
--- a/const/export
+++ b/const/export
@@ -1,4 +1,4 @@
 cp make/const_lib.mod ../include
 cp make/const_def.mod ../include
 
-cp make/libconst*.a ../lib
+cp make/libconst*.so ../lib
diff --git a/const/make/makefile b/const/make/makefile
index 6027577..c37c3ec 100644
--- a/const/make/makefile
+++ b/const/make/makefile
@@ -20,7 +20,7 @@ SRCS = \
 #
 # TARGETS
 
-LIB = libconst.a
+LIB = libconst.so
 LIB_OBJS = $(patsubst %.f,%.o,$(patsubst %.f90,%.o,$(SRCS)))
 $(LIB) : $(LIB_OBJS)
 	$(LIB_TOOL) $(LIB) $(LIB_OBJS)
diff --git a/crlibm/build_and_test_mic_native b/crlibm/build_and_test_mic_native
index 4ad30dd..b1b64e8 100755
--- a/crlibm/build_and_test_mic_native
+++ b/crlibm/build_and_test_mic_native
@@ -27,7 +27,7 @@ then
   rm -f crlibm-1.0beta4.tar
   cp crlibm/crlibm.h ../include
   check_okay
-  cp crlibm/libcrlibm*.a ../lib
+  cp crlibm/libcrlibm*.so ../lib
   check_okay
 fi
 
diff --git a/crlibm/export b/crlibm/export
index 7f46310..4b0b667 100755
--- a/crlibm/export
+++ b/crlibm/export
@@ -1,7 +1,7 @@
 #!/bin/bash
 
 cp make/crlibm_lib.mod ../include
-cp make/libf2crlibm*.a ../lib
+cp make/libf2crlibm*.so ../lib
 if [ -e make/libcrlibm.a ]
 then
 cp crlibm/libcrlibm*.a ../lib
diff --git a/crlibm/make/makefile b/crlibm/make/makefile
index d48c87a..0063b4e 100644
--- a/crlibm/make/makefile
+++ b/crlibm/make/makefile
@@ -11,7 +11,7 @@ include $(MESA_DIR)/utils/makefile_header
 
 # STEP 2: build the library
 
-LIB = libf2crlibm.a
+LIB = libf2crlibm.so
 LIB_DEFS = 
 
 ifeq ($(USE_STUB_FOR_CRLIBM),YES)
@@ -26,7 +26,7 @@ $(LIB) : $(LIB_DEFS) $(LIB_OBJS)
 	
 #################################################################
 
-COMPILE_C = $(CC) -O3 -w -fno-common -fexceptions
+COMPILE_C = $(CC) -O3 -w -fno-common -fexceptions -fPIC -shared
 COMPILE = $(COMPILE_TO_DEPLOY) $(FCfree)
 #COMPILE = $(COMPILE_TO_TEST) $(FCfree)
 
diff --git a/eos/export b/eos/export
index f2a4616..fee833f 100755
--- a/eos/export
+++ b/eos/export
@@ -1,4 +1,4 @@
 cp make/eos_def.mod ../include
 cp make/eos_lib.mod ../include
 
-cp make/libeos*.a ../lib
+cp make/libeos*.so ../lib
diff --git a/eos/make/makefile b/eos/make/makefile
index 5d67123..32decaa 100644
--- a/eos/make/makefile
+++ b/eos/make/makefile
@@ -33,7 +33,7 @@ SRCS = \
 #
 # TARGETS
 
-LIB = libeos.a
+LIB = libeos.so
 LIB_OBJS = $(patsubst %.f,%.o,$(patsubst %.f90,%.o,$(SRCS)))
 $(LIB) : $(LIB_OBJS)
 	$(LIB_TOOL) $(LIB) $(LIB_OBJS)
diff --git a/gyre/export b/gyre/export
index d283d72..2f5aa5a 100755
--- a/gyre/export
+++ b/gyre/export
@@ -2,5 +2,5 @@ cp make/gyre_lib.f90 public/gyre_lib.f
 
 cp make/gyre_lib.mod ../include
 
-cp make/libgyre*.a ../lib
+cp make/libgyre*.so ../lib
 
diff --git a/gyre/make/makefile b/gyre/make/makefile
index 07dd7a9..fa332f9 100644
--- a/gyre/make/makefile
+++ b/gyre/make/makefile
@@ -13,7 +13,7 @@ ifeq ($(USE_GYRE),NO)
 
 # STEP 2: build a stub library
 
-LIB = libgyre.a
+LIB = libgyre.so
 LIB_OBJS = gyre_lib_stub.o
 
 $(LIB) : $(LIB_OBJS)
diff --git a/interp_1d/export b/interp_1d/export
index 3920e17..596b2d8 100755
--- a/interp_1d/export
+++ b/interp_1d/export
@@ -2,4 +2,4 @@ cp make/interp_1d_def.mod ../include
 cp make/interp_1d_lib.mod ../include
 cp make/interp_1d_lib_sg.mod ../include
 
-cp make/libinterp_1d*.a ../lib
+cp make/libinterp_1d*.so ../lib
diff --git a/interp_1d/make/makefile b/interp_1d/make/makefile
index bc056ff..5cf76e0 100644
--- a/interp_1d/make/makefile
+++ b/interp_1d/make/makefile
@@ -27,7 +27,7 @@ SRCS = \
 #
 # TARGETS
 
-LIB = libinterp_1d.a
+LIB = libinterp_1d.so
 LIB_OBJS = $(patsubst %.f,%.o,$(patsubst %.f90,%.o,$(SRCS)))
 $(LIB) : $(LIB_OBJS)
 	$(LIB_TOOL) $(LIB) $(LIB_OBJS)
diff --git a/interp_2d/export b/interp_2d/export
index fb041d8..03b3554 100755
--- a/interp_2d/export
+++ b/interp_2d/export
@@ -2,4 +2,4 @@ cp make/interp_2d_lib_db.mod ../include
 cp make/interp_2d_lib_sg.mod ../include
 cp make/masked_spline_townsend_db.mod ../include
 
-cp make/libinterp_2d*.a ../lib
+cp make/libinterp_2d*.so ../lib
diff --git a/interp_2d/make/makefile b/interp_2d/make/makefile
index ee6bfa6..aa5f54f 100644
--- a/interp_2d/make/makefile
+++ b/interp_2d/make/makefile
@@ -29,7 +29,7 @@ SRCS = \
 #
 # TARGETS
 
-LIB = libinterp_2d.a
+LIB = libinterp_2d.so
 LIB_OBJS = $(patsubst %.f,%.o,$(patsubst %.f90,%.o,$(SRCS)))
 $(LIB) : $(LIB_OBJS)
 	$(LIB_TOOL) $(LIB) $(LIB_OBJS)
diff --git a/ionization/export b/ionization/export
index d546fee..0f361d3 100755
--- a/ionization/export
+++ b/ionization/export
@@ -1,4 +1,4 @@
 cp make/ionization_def.mod ../include
 cp make/ionization_lib.mod ../include
 
-cp make/libionization*.a ../lib
+cp make/libionization*.so ../lib
diff --git a/ionization/make/makefile b/ionization/make/makefile
index 31a05b9..89fd14e 100644
--- a/ionization/make/makefile
+++ b/ionization/make/makefile
@@ -25,7 +25,7 @@ SRCS = \
 #
 # TARGETS
 
-LIB = libionization.a
+LIB = libionization.so
 LIB_OBJS = $(patsubst %.f,%.o,$(patsubst %.f90,%.o,$(SRCS)))
 $(LIB) : $(LIB_OBJS)
 	$(LIB_TOOL) $(LIB) $(LIB_OBJS)
diff --git a/kap/export b/kap/export
index e30663b..7620d37 100755
--- a/kap/export
+++ b/kap/export
@@ -1,4 +1,4 @@
 cp make/kap_def.mod ../include
 cp make/kap_lib.mod ../include
 
-cp make/libkap*.a ../lib
+cp make/libkap*.so ../lib
diff --git a/kap/make/makefile b/kap/make/makefile
index 2f25bdc..27e08ef 100644
--- a/kap/make/makefile
+++ b/kap/make/makefile
@@ -33,7 +33,7 @@ SRCS = \
 #
 # TARGETS
 
-LIB = libkap.a
+LIB = libkap.so
 LIB_OBJS = $(patsubst %.f,%.o,$(patsubst %.f90,%.o,$(SRCS)))
 $(LIB) : $(LIB_OBJS)
 	$(LIB_TOOL) $(LIB) $(LIB_OBJS)
diff --git a/kap/private/kap_eval_support.f90 b/kap/private/kap_eval_support.f90
index bd4f1f9..43bc33f 100644
--- a/kap/private/kap_eval_support.f90
+++ b/kap/private/kap_eval_support.f90
@@ -36,6 +36,7 @@
             rq, num_logs, log_min_in, log_max_in, ili_logs, logs, log_find, i, log0, log1, ierr)
          use kap_def
          use num_lib, only: binary_search
+         use utils_lib, only: is_bad
          type (Kap_General_Info), pointer :: rq
          integer, intent(in) :: num_logs, ili_logs
          real(dp), intent(in) :: log_min_in, log_max_in
diff --git a/mlt/export b/mlt/export
index fcd2c35..39e0eb8 100755
--- a/mlt/export
+++ b/mlt/export
@@ -1,4 +1,4 @@
 cp make/mlt_def.mod ../include
 cp make/mlt_lib.mod ../include
 
-cp make/libmlt*.a ../lib
+cp make/libmlt*.so ../lib
diff --git a/mlt/make/makefile b/mlt/make/makefile
index 259e99c..abdaf85 100644
--- a/mlt/make/makefile
+++ b/mlt/make/makefile
@@ -21,7 +21,7 @@ SRCS = \
 #
 # TARGETS
 
-LIB = libmlt.a
+LIB = libmlt.so
 LIB_DEFS = mlt_def.o 
 LIB_OBJS =$(filter-out $(LIB_DEFS),$(patsubst %.f,%.o,$(patsubst %.f90,%.o,$(SRCS))))
 $(LIB) : $(LIB_DEFS) $(LIB_OBJS)
diff --git a/mtx/export b/mtx/export
index f0f2209..e1f7d91 100755
--- a/mtx/export
+++ b/mtx/export
@@ -3,14 +3,14 @@ cp make/mtx_lib.mod ../include
 cp public/mtx_*.dek ../include
 cp public/mtx_*.inc ../include
 
-if [ -r make/libmesablas.a ]
+if [ -r make/libmesablas.so ]
 then
-cp make/libmesablas*.a ../lib
+cp make/libmesablas*.so ../lib
 fi
 
-if [ -r make/libmesalapack.a ]
+if [ -r make/libmesalapack.so ]
 then
-cp make/libmesalapack*.a ../lib
+cp make/libmesalapack*.so ../lib
 fi
 
-cp make/libmtx*.a ../lib
+cp make/libmtx*.so ../lib
diff --git a/mtx/make/makefile b/mtx/make/makefile
index 77433b0..2be8b3e 100644
--- a/mtx/make/makefile
+++ b/mtx/make/makefile
@@ -222,7 +222,7 @@ endif
 #
 # TARGETS
 
-LIB = libmtx.a
+LIB = libmtx.so
 MTX_OBJS = $(patsubst %.f,%.o,$(patsubst %.f90,%.o,$(MTX_SRCS)))
 LAPACK_QUAD_OBJS = $(patsubst %.f,%.o,$(patsubst %.f90,%.o,$(LAPACK_QUAD_SRCS)))
 LIB_OBJS = $(MTX_OBJS) $(LAPACK_QUAD_OBJS)
@@ -230,14 +230,14 @@ $(LIB) : mtx_def.o $(LIB_OBJS)
 	$(LIB_TOOL) $(LIB) $(LIB_OBJS)
 
 ifeq ($(WHICH_LAPACK),USE_SRCS)
-   LAPACK_LIB = libmesalapack.a
+   LAPACK_LIB = libmesalapack.so
    LAPACK_OBJS = $(patsubst %.f,%.o,$(patsubst %.f90,%.o,$(LAPACK_SRCS)))
    $(LAPACK_LIB) : $(LAPACK_OBJS)
 	$(LIB_TOOL) $(LAPACK_LIB) $(LAPACK_OBJS)	
 endif
 
 ifeq ($(WHICH_BLAS),USE_SRCS)
-   BLAS_LIB = libmesablas.a
+   BLAS_LIB = libmesablas.so
    BLAS_OBJS = $(patsubst %.f,%.o,$(patsubst %.f90,%.o,$(BLAS_SRCS)))
    $(BLAS_LIB) : $(BLAS_OBJS)
 	$(LIB_TOOL) $(BLAS_LIB) $(BLAS_OBJS)
@@ -251,17 +251,22 @@ all : $(BLAS_LIB) $(LAPACK_LIB) $(LIB)
 #
 # COMPILATION RULES
 
+COMPILE_LEGACY = $(filter-out -std=f2008, $(COMPILE_TO_DEPLOY))
+
 #COMPILE = $(COMPILE_TO_TEST) $(FCfixed)
-COMPILE = $(COMPILE_TO_DEPLOY) $(FCfixed)
+COMPILE = $(COMPILE_LEGACY) $(FCfixed)
 #COMPILE_FREE = $(COMPILE_TO_TEST) $(FCfree)
-COMPILE_FREE = $(COMPILE_TO_DEPLOY) $(FCfree)
+COMPILE_FREE = $(COMPILE_LEGACY) $(FCfree)
 
 #COMPILE_FREE = $(COMPILE_TO_DEPLOY) $(FCfree) $(FCwarn_unused)
 
-COMPILE_XTRA = $(COMPILE_BASIC) $(FCwarn) $(FCimpno) $(FCopt) -c $(FCfixed)
-COMPILE_XTRA_TEST = $(COMPILE_BASIC) $(FCwarn) $(FCimpno) $(FCopt) $(FCchecks) -g -c $(FCfixed)
-COMPILE_XTRA_FREE = $(COMPILE_BASIC) $(FCwarn) $(FCimpno) $(FCopt) -c $(FCfree)
-COMPILE_XTRA_NO_OPT = $(COMPILE_BASIC) $(FCnowarn) $(FCfixed) -c
+COMPILE_BASIC_LEGACY = $(filter-out -std=f2008, $(COMPILE_BASIC))
+
+
+COMPILE_XTRA = $(COMPILE_BASIC_LEGACY) $(FCwarn) $(FCimpno) $(FCopt) -c $(FCfixed)
+COMPILE_XTRA_TEST = $(COMPILE_BASIC_LEGACY) $(FCwarn) $(FCimpno) $(FCopt) $(FCchecks) -g -c $(FCfixed)
+COMPILE_XTRA_FREE = $(COMPILE_BASIC_LEGACY) $(FCwarn) $(FCimpno) $(FCopt) -c $(FCfree)
+COMPILE_XTRA_NO_OPT = $(COMPILE_BASIC_LEGACY) $(FCnowarn) $(FCfixed) -c
 
 COMPILE_CMD = $(COMPILE)
 
diff --git a/net/export b/net/export
index af80599..9179d98 100755
--- a/net/export
+++ b/net/export
@@ -3,4 +3,4 @@ rm -f ../data/net/cache/*.bin
 cp make/net_lib.mod ../include
 cp make/net_def.mod ../include
 
-cp make/libnet*.a ../lib
+cp make/libnet*.so ../lib
diff --git a/net/make/makefile b/net/make/makefile
index 9a4388e..9e64933 100644
--- a/net/make/makefile
+++ b/net/make/makefile
@@ -33,7 +33,7 @@ SRCS = \
 #
 # TARGETS
 
-LIB = libnet.a
+LIB = libnet.so
 LIB_OBJS = $(patsubst %.f,%.o,$(patsubst %.f90,%.o,$(SRCS)))
 $(LIB) : $(LIB_OBJS)
 	$(LIB_TOOL) $(LIB) $(LIB_OBJS)
diff --git a/neu/export b/neu/export
index 351e7a2..a8a67da 100755
--- a/neu/export
+++ b/neu/export
@@ -1,4 +1,4 @@
 cp make/neu_lib.mod ../include
 cp make/neu_def.mod ../include
 
-cp make/libneu*.a ../lib
+cp make/libneu*.so ../lib
diff --git a/neu/make/makefile b/neu/make/makefile
index 4e6a08c..c0a7216 100644
--- a/neu/make/makefile
+++ b/neu/make/makefile
@@ -21,7 +21,7 @@ SRCS = \
 #
 # TARGETS
 
-LIB = libneu.a
+LIB = libneu.so
 LIB_DEFS = neu_def.o
 LIB_OBJS =$(filter-out $(LIB_DEFS),$(patsubst %.f,%.o,$(patsubst %.f90,%.o,$(SRCS))))
 $(LIB) : $(LIB_DEFS) $(LIB_OBJS)
diff --git a/num/export b/num/export
index de2b380..3bd17bc 100755
--- a/num/export
+++ b/num/export
@@ -8,4 +8,4 @@ cp public/num_solout.dek ../include
 cp public/num_mas.dek ../include
 cp public/num_interp_y.dek ../include
 
-cp make/libnum*.a ../lib
+cp make/libnum*.so ../lib
diff --git a/num/make/makefile b/num/make/makefile
index 9f56361..f5f7863 100644
--- a/num/make/makefile
+++ b/num/make/makefile
@@ -23,7 +23,7 @@ SRCS = \
 #
 # TARGETS
 
-LIB = libnum.a
+LIB = libnum.so
 LIB_DEFS = num_def.o
 LIB_OBJS = $(filter-out $(LIB_DEFS),$(patsubst %.f,%.o,$(patsubst %.f90,%.o,$(SRCS))))
 $(LIB) : $(LIB_DEFS) $(LIB_OBJS)
diff --git a/package_template/export b/package_template/export
index 2949ffe..fd5c4d8 100755
--- a/package_template/export
+++ b/package_template/export
@@ -1,4 +1,4 @@
 cp make/xxx_lib.mod ../include
 cp make/xxx_def.mod ../include
 
-cp make/libxxx*.a ../lib
+cp make/libxxx*.so ../lib
diff --git a/package_template/make/makefile b/package_template/make/makefile
index 92ab385..413d6cf 100644
--- a/package_template/make/makefile
+++ b/package_template/make/makefile
@@ -18,7 +18,7 @@ SRCS = pkg_mod.f \
 #
 # TARGETS
 
-LIB = libpkg.a
+LIB = libpkg.so
 LIB_OBJS = $(patsubst %.f,%.o,$(patsubst %.f90,%.o,$(SRCS)))
 $(LIB) : $(LIB_OBJS)
 	$(LIB_TOOL) $(LIB) $(LIB_OBJS)
diff --git a/rates/export b/rates/export
index 726b0b0..dfecb8c 100755
--- a/rates/export
+++ b/rates/export
@@ -1,4 +1,4 @@
 cp make/rates_lib.mod ../include
 cp make/rates_def.mod ../include
 
-cp make/librates*.a ../lib
+cp make/librates*.so ../lib
diff --git a/rates/make/makefile b/rates/make/makefile
index 492923d..b8f1905 100644
--- a/rates/make/makefile
+++ b/rates/make/makefile
@@ -43,7 +43,7 @@ SRCS = \
 #
 # TARGETS
 
-LIB = librates.a
+LIB = librates.so
 LIB_OBJS = $(patsubst %.f,%.o,$(patsubst %.f90,%.o,$(SRCS)))
 $(LIB) : $(LIB_OBJS)
 	$(LIB_TOOL) $(LIB) $(LIB_OBJS)
diff --git a/rates/private/weaklib_tables.f90 b/rates/private/weaklib_tables.f90
index 6f3e719..780effb 100644
--- a/rates/private/weaklib_tables.f90
+++ b/rates/private/weaklib_tables.f90
@@ -28,7 +28,7 @@ module weaklib_tables
 
   use const_def
   use crlibm_lib
-  use utils_lib, only: mesa_error
+  use utils_lib, only: mesa_error, is_bad
   use rates_def
 
   implicit none
diff --git a/star/export b/star/export
index 60c4639..e329252 100755
--- a/star/export
+++ b/star/export
@@ -7,7 +7,7 @@ cp make/pulse.mod ../include
 cp job/*.inc ../include
 cp job/*.dek ../include
 
-cp make/libstar*.a ../lib
+cp make/libstar*.so ../lib
 
 cd ../star
 if [ -e make/libstar++.a ]
diff --git a/star/make/makefile b/star/make/makefile
index a6e8858..dc7bdcb 100644
--- a/star/make/makefile
+++ b/star/make/makefile
@@ -200,7 +200,7 @@ SRCS = \
 #
 # TARGETS
 
-LIB = libstar.a
+LIB = libstar.so
 LIB_DEFS = 
 LIB_OBJS = $(patsubst %.f,%.o,$(patsubst %.f90,%.o,$(SRCS)))
 $(LIB) : $(LIB_DEFS) $(LIB_OBJS)
diff --git a/utils/export b/utils/export
index fbc2921..f2fb1a1 100755
--- a/utils/export
+++ b/utils/export
@@ -4,4 +4,4 @@ cp formats.dek ../include/formats
 
 cp make/*.mod ../include
 
-cp make/libutils*.a ../lib
+cp make/libutils*.so ../lib
diff --git a/utils/make/makefile b/utils/make/makefile
index 8e35ae7..40c9f18 100644
--- a/utils/make/makefile
+++ b/utils/make/makefile
@@ -33,7 +33,7 @@ SRCS = \
 #
 # TARGETS
 
-LIB = libutils.a
+LIB = libutils.so
 LIB_OBJS = $(patsubst %.f,%.o,$(patsubst %.f90,%.o,$(SRCS)))
 $(LIB) : $(LIB_OBJS)
 	$(LIB_TOOL) $(LIB) $(LIB_OBJS)
diff --git a/utils/makefile_header b/utils/makefile_header
index 5979b09..af5ff8b 100644
--- a/utils/makefile_header
+++ b/utils/makefile_header
@@ -40,6 +40,8 @@ endif
 FC = gfortran
 CC = gcc
 
+SPECIAL_FC_FLAGS = -fPIC -shared
+SPECIAL_C_FLAGS   = 
 
 # step 2) specify whether isnan is supported or not (NO LONGER NEEDED!)
 
@@ -48,10 +50,10 @@ CC = gcc
 
 # step 3) specify which BLAS and LAPACK libraries to use for mesa/mtx
 
-WHICH_LAPACK =
-WHICH_BLAS =
-LOAD_LAPACK = `mesasdk_lapack_link`
-LOAD_BLAS = `mesasdk_blas_link`
+WHICH_LAPACK = USE_SRCS
+LOAD_LAPACK = -lmesalapack
+WHICH_BLAS = USE_SRCS
+LOAD_BLAS = -lmesablas
 
 
 # step 4) do you want to use PGPLOT with mesa/star?                                                                                     
@@ -79,7 +81,7 @@ USE_GYRE = YES
 
 USE_OPENMP = YES
 
-USE_STUB_FOR_CRLIBM = NO
+USE_STUB_FOR_CRLIBM = YES
 
 #################################################################
 
-- 
2.9.4

